import{b as L,d as S,q as v,a5 as h,am as $,x as A,a6 as c,aU as P,y as w,a2 as D,S as j,dg as H,aH as B,e2 as R}from"./index-ec8d78f2.js";var F=B("<div id=heic-container><canvas>");const W=()=>{const x=L(),{replace:y}=S(),[u,o]=v(!0),[p,f]=v(!1);let s=h.objs.filter(e=>/\.(heic|heif|avif|vvc|avc|jpeg|jpg)$/i.test(e.name));s.length===0&&(s=[h.obj]);const g=e=>{const t=s.findIndex(r=>r.name===h.obj.name);e.key==="ArrowLeft"&&t>0?y(s[t-1].name):e.key==="ArrowRight"&&t<s.length-1&&y(s[t+1].name)};let d,l,i=null;$(()=>{window.addEventListener("keydown",g),E()}),A(()=>{window.removeEventListener("keydown",g),d&&l&&(l.free(),l=null),d=null});const E=async()=>{o(!0),f(!1);try{window.libheif||await _("/static/libheif/libheif.js","libheif-script");const e=await k("/static/libheif/libheif.wasm");d=window.libheif({wasmBinary:e}),l=new d.HeifDecoder,await C(h.raw_url)}catch(e){console.error("HEIC初始化失败:",e),f(!0),o(!1)}},_=(e,t)=>new Promise((r,n)=>{const a=document.createElement("script");a.src=e,a.id=t,a.onload=()=>r(),a.onerror=()=>n(new c("脚本加载失败: ".concat(e))),document.head.appendChild(a)}),k=async e=>{const t=await fetch(e);if(!t.ok)throw new c("WASM加载失败: ".concat(e));return await t.arrayBuffer()},C=async e=>{try{o(!0),f(!1);const t=await fetch(e);if(!t.ok)throw new c("文件获取失败");const r=await t.arrayBuffer(),n=l.decode(r);if(!n||n.length===0)throw new c("没有可解码的图像");const a=n[0];await I(a),o(!1)}catch(t){console.error("HEIC解码失败:",t),f(!0),o(!1)}},I=e=>new Promise(t=>{if(!i)return t();const r=e.get_width(),n=e.get_height();i.width=r,i.height=n;const a=new ImageData(r,n);e.display(a,m=>{if(!m||!i)return t();const b=i.getContext("2d");if(!b)return t();b.putImageData(m,0,0),t()})});return(()=>{var e=F(),t=e.firstChild;e.style.setProperty("position","relative"),e.style.setProperty("width","100%"),e.style.setProperty("height","75vh"),e.style.setProperty("display","flex"),e.style.setProperty("justify-content","center"),e.style.setProperty("align-items","center"),e.style.setProperty("overflow","hidden");var r=i;return typeof r=="function"?R(r,t):i=t,t.style.setProperty("max-width","100%"),t.style.setProperty("max-height","100%"),t.style.setProperty("object-fit","contain"),P(e,w(j,{get when(){return u()},get children(){return w(D,{})}}),null),P(e,w(j,{get when(){return p()},get children(){return w(c,{get msg(){return x("preview.failed_load_heic")},h:"75vh"})}}),null),H(n=>(n=u()||p()?"none":"block")!=null?t.style.setProperty("display",n):t.style.removeProperty("display")),e})()};export{W as default};
