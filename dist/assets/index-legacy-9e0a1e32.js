System.register(["./index-legacy-4ff8c94f.js","./index-legacy-c8a90fd5.js","./webauthn-json.browser-ponyfill-legacy-2d91bd49.js"],function(e,t){"use strict";var n,r,o,a,s,l,i,c,u,g,d,h,p,m,w,b,f,$,y,_,v,k,I,S,C,x,E,j,z,P,U,A,D,K,R,G,L,T,M,Q,q,F,J,N;return{setters:[e=>{n=e.cd,r=e.af,o=e.W,a=e.d,s=e.c8,l=e.ce,i=e.x,c=e.y,u=e.aQ,g=e.bm,d=e.cf,h=e.cg,p=e.ch,m=e.Z,w=e.b,b=e.G,f=e.q,$=e.ci,y=e.b5,_=e.am,v=e.aa,k=e.bT,I=e.aD,S=e.bS,C=e.S,x=e.I,E=e.b7,j=e.a9,z=e.Q,P=e.aA,U=e.D,A=e.bx,D=e.aG,K=e.n,R=e.bn,G=e.cj},e=>{L=e.F,T=e.f,M=e.a,Q=e.S,q=e.g},e=>{F=e.s,J=e.g,N=e.a}],execute:function(){const t=()=>{const e=r("sso_login_enabled"),t=o("sso_login_platform"),n=r("sso_compatibility_mode"),{searchParams:m,to:w}=a(),b=m.token;function f(e){const t=e.data;t.token&&(s(t.token),w(decodeURIComponent(m.redirect||l||"/"),!0))}if(null!=b&&""!=b&&(s(b),w(decodeURIComponent(m.redirect||l||"/"),!0)),window.addEventListener("message",f),i(()=>{window.removeEventListener("message",f)}),e){const e=()=>{const e=g.getUri()+"/auth/sso?method=sso_get_token";n?window.location.href=e:window.open(e,"authPopup","width=500,height=600")};let r;switch(t){case"Github":r=T;break;case"Microsoft":r=p;break;case"Google":r=h;break;case"Dingtalk":r=d;break;default:r=L}return c(u,{cursor:"pointer",boxSize:"$8",as:r,p:"$0_5",onclick:e})}};e("default",()=>{const e=o("logo").split("\n"),d=m(e[0],e.pop()),h=w(),p=b(()=>`${o("site_title")}`);M(p);const L=m("white","$neutral1"),[T,O]=f(localStorage.getItem("username")||""),[W,Z]=f(localStorage.getItem("password")||""),[B,H]=f(""),[V,X]=f(!1),[Y,ee]=$("remember-pwd","false"),[te,ne]=f(!1),[re,oe]=y(async()=>{return te()?g.post("/auth/login/ldap",{username:T(),password:W(),otp_code:B()}):g.post("/auth/login/hash",{username:T(),password:(e=W(),n(`${e}-https://github.com/li-peifeng/inoi`)),otp_code:B()});var e}),[,ae]=y((e,t,n,r)=>g.post("/authn/webauthn_finish_login?username="+n,JSON.stringify(t),{headers:{session:e},signal:r})),[,se]=y((e,t)=>g.get("/authn/webauthn_begin_login?username="+e,{signal:t})),{searchParams:le,to:ie}=a(),ce=r("webauthn_login_enabled"),ue=async()=>{X(!V())};let ge=null;const de=async e=>{if(!F())return void(e||K.error(h("users.webauthn_not_supported")));if(e&&!(await(async()=>!(!PublicKeyCredential||!("isConditionalMediationAvailable"in PublicKeyCredential))&&await PublicKeyCredential.isConditionalMediationAvailable())()))return;ge?.abort();const t=new AbortController;ge=t;const n=e?"":T();e||"true"!==Y()?localStorage.removeItem("username"):localStorage.setItem("username",T());const r=await se(n,t.signal);R(r,async r=>{try{const o=J(r.options);o.signal=t.signal,e&&(o.mediation="conditional");const a=await N(o),i=await ae(r.session,a,n,t.signal);G(i,e=>{K.success(h("login.success")),s(e.token),ie(decodeURIComponent(le.redirect||l||"/"),!0)})}catch(o){o instanceof Error&&"AbortError"!=o.name&&K.error(o.message)}})},he=()=>ge?.abort();_(()=>{ce&&(window.addEventListener("beforeunload",he),de(!0))}),i(()=>{ge?.abort(),window.removeEventListener("beforeunload",he)});const pe=async()=>{if(V())await de();else{"true"===Y()?(localStorage.setItem("username",T()),localStorage.setItem("password",W())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const e=await oe();G(e,e=>{K.success(h("login.success")),s(e.token),ie(decodeURIComponent(le.redirect||l||"/"),!0)},(e,t)=>{me()||402!==t?K.error(e):we(!0)})}},[me,we]=f(!1),be=r("ldap_login_enabled"),fe=o("ldap_login_tips");return be&&ne(!0),c(D,{zIndex:"1",w:"$full",h:"100vh",get children(){return c(v,{get bgColor(){return L()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[c(k,{alignItems:"center",justifyContent:"space-around",get children(){return[c(I,{mr:"$2",boxSize:"$12",get src(){return d()}}),c(S,{color:"$info9",fontSize:"$2xl",get children(){return p()}})]}}),c(C,{get when(){return!me()},get fallback(){return c(x,{id:"totp",name:"otp",get placeholder(){return h("login.otp-tips")},get value(){return B()},onInput:e=>H(e.currentTarget.value),onKeyDown:e=>{"Enter"===e.key&&pe()}})},get children(){return[c(x,{name:"username",get placeholder(){return h("login.username-tips")},get value(){return T()},onInput:e=>O(e.currentTarget.value)}),c(C,{get when(){return!V()},get children(){return c(x,{name:"password",get placeholder(){return h("login.password-tips")},type:"password",get value(){return W()},onInput:e=>Z(e.currentTarget.value),onKeyDown:e=>{"Enter"===e.key&&pe()}})}}),c(k,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return[c(E,{get checked(){return"true"===Y()},onChange:()=>ee("true"===Y()?"false":"true"),get children(){return h("login.remember")}}),c(j,{color:"$success9",as:z,href:"https://peifeng.li/cloud-help",get children(){return h("login.help")}})]}})]}}),c(P,{w:"$full",spacing:"$2",get children(){return[c(C,{get when(){return!V()},get children(){return[c(U,{w:"$full",colorScheme:"danger",onClick:()=>{s(),ie(decodeURIComponent(le.redirect||l||"/"),!0)},get children(){return h("login.use_guest")}}),c(U,{colorScheme:"warning",w:"$full",onClick:()=>{me()?H(""):(O(""),Z(""))},get children(){return h("login.clear")}})]}}),c(U,{colorScheme:"success",w:"$full",get loading(){return re()},onClick:pe,get children(){return h("login.login")}})]}}),c(C,{when:be,get children(){return c(E,{w:"$full",get checked(){return!0===te()},onChange:()=>ne(!te()),children:fe})}}),c(k,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[c(Q,{}),c(t,{}),c(C,{when:ce,get children(){return c(u,{cursor:"pointer",boxSize:"$8",as:q,p:"$0_5",onclick:ue})}}),c(A,{})]}})]}})}})})}}});
