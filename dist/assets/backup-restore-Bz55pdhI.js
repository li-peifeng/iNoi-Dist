import{C as j,bd as i,bv as d,E as o,aH as q,L as J,q as he,bV as be,c3 as ye,bI as A,bU as we,I as Se,ag as H,U as _e,cw as $,x as ke,ae as N}from"./index-CIhEx_5u.js";import{f as Le}from"./index-_heXIZnM.js";import{c as f}from"./index-Bx25HCXr.js";const V={success:{icon:"✅",color:"$success9"},error:{icon:"❌",color:"$danger9"},info:{icon:"ℹ️",color:"$info9"}},$e=p=>o(q,{w:"$full",spacing:"$1",get children(){return[o(N,{get children(){return V[p.type].icon}}),o(N,{get color(){return V[p.type].color},get children(){return p.msg}})]}}),De=()=>{const[p,v]=j(!1),[h,S]=j(""),t=he();Le("manage.sidemenu.backup-restore");let y;const[P,W]=j([]),u=(e,r)=>{W(g=>[...g,{type:r,msg:e}]),y&&(y.scrollTop=y.scrollHeight)},[Y,z]=i(()=>d.get("/admin/setting/list")),[G,D]=i(()=>d.get("/admin/user/list")),[K,O]=i(()=>d.get("/admin/meta/list")),[Q,x]=i(()=>d.get("/admin/storage/list")),[X,M]=i(()=>d.get("/share/list")),Z=()=>Y()||G()||K()||Q()||X();function U(e,r){if(r=="")return e;const g=f.AES.encrypt(JSON.stringify(e),r).toString();return f.enc.Base64.stringify(f.enc.Utf8.parse(g))}function R(e,r,g,c){if(!c)return e;const s=f.enc.Base64.parse(e).toString(f.enc.Utf8);return g?f.AES.decrypt(s,r).toString(f.enc.Utf8):JSON.parse(f.AES.decrypt(s,r).toString(f.enc.Utf8))}const T=async()=>{u(t("br.start_backup"),"info");const e={encrypted:"",settings:[],users:[],storages:[],metas:[],shares:[]};h()!=""&&(e.encrypted=U("encrypted",h()));for(const r of[{name:"settings",fn:z,page:!1},{name:"users",fn:D,page:!0},{name:"storages",fn:x,page:!0},{name:"metas",fn:O,page:!0},{name:"shares",fn:M,page:!0}]){const g=await r.fn();$(g,c=>{if(u(t("br.success_backup_item",{item:t("manage.sidemenu.".concat(r.name))}),"success"),r.page){for(let s=0;s<c.content.length;s++){const n=c.content[s];for(const m in n)n[m]=U(n[m],h())}e[r.name]=c.content}else{for(let s=0;s<c.length;s++){const n=c[s];for(const m in n)n[m]=U(n[m],h())}e[r.name]=c}},c=>{u(t("br.failed_backup_item",{item:t("manage.sidemenu.".concat(r.name))})+":"+c,"error")})}ve("openlist_backup_"+new Date().toLocaleString()+".json",e),u(t("br.finish_backup"),"info")},[ee,te]=i(e=>d.post("/admin/setting/save",e)),[ne,B]=i(e=>d.post("/admin/user/create",e)),[re,C]=i(e=>d.post("/admin/storage/create",e)),[ae,E]=i(e=>d.post("/admin/meta/create",e)),[se,F]=i(e=>d.post("/share/create",e)),[oe,ce]=i(e=>d.post("/admin/user/update",e)),[ie,de]=i(e=>d.post("/admin/storage/update",e)),[ue,ge]=i(e=>d.post("/admin/meta/update",e)),[le,me]=i(e=>d.post("/share/update",e));async function _(e,r,g,c,s,n){const m=(await r()).data.content;for(const w in e){const a=e[w],l=a[s],L=(m.find(I=>I[s]===l)?"update":"add")==="add"?g:c;await $(await L(a),()=>{u(t("br.success_restore_item",{item:t(n)})+"-[".concat(l,"]"),"success")},I=>{u(t("br.failed_restore_item",{item:t(n)})+"-[".concat(l,"]:")+I,"error")})}}const pe=()=>ee()||ne()||re()||ae()||se()||oe()||ie()||ue()||le(),fe=async()=>{u(t("br.start_restore"),"info");const e=document.createElement("input");e.type="file",e.accept="application/json",e.onchange=async r=>{const g=r.target.files;if(!g||g.length===0){ke.warning(t("br.no_file"));return}const c=g[0],s=new FileReader;s.onload=async()=>{const n=JSON.parse(s.result),m=!!n.encrypted;if(m&&R(n.encrypted,h(),!0,!0)!=='"encrypted"'){u(t("br.wrong_encrypt_password"),"error");return}const w=Object.values(n);for(let a=w.length-4;a<w.length;a++){const l=w[a];console.log(l);for(let b=0;b<l.length;b++){const k=l[b];for(const L in k)k[L]=R(k[L],h(),!1,m)}}if(p()&&await T(),n.settings&&$(await te(n.settings.filter(a=>!["version","index_progress"].includes(a.key))),()=>{u(t("br.success_restore_item",{item:t("manage.sidemenu.settings")}),"success")},a=>{u(t("br.failed_restore_item",{item:t("manage.sidemenu.settings")})+":"+a,"error")}),p())await _(n.users,D,B,ce,"username","manage.sidemenu.users"),await _(n.storages,x,C,de,"mount_path","manage.sidemenu.storages"),await _(n.metas,O,E,ge,"path","manage.sidemenu.metas"),await _(n.shares,M,F,me,"id","manage.sidemenu.shares");else for(const a of[{name:"users",fn:B,data:n.users,key:"username",removeId:!0},{name:"storages",fn:C,data:n.storages,key:"mount_path",removeId:!0},{name:"metas",fn:E,data:n.metas,key:"path",removeId:!0},{name:"shares",fn:F,data:n.shares,key:"id",removeId:!1}])for(const l of a.data||[])a.removeId&&(l.id=0),$(await a.fn(l),()=>{u(t("br.success_restore_item",{item:t("manage.sidemenu.".concat(a.name))})+"-[".concat(l[a.key],"]"),"success")},b=>{u(t("br.failed_restore_item",{item:t("manage.sidemenu.".concat(a.name))})+" [ ".concat(l[a.key]," ] :")+b,"error")});u(t("br.finish_restore"),"info")},s.readAsText(c)},e.click()};return o(H,{spacing:"$2",w:"$full",get children(){return[o(q,{spacing:"$2",w:"$full",get children(){return[o(J,{get loading(){return Z()},onClick:()=>{T()},colorScheme:"accent",get children(){return t("br.backup")}}),o(J,{get loading(){return pe()},onClick:()=>{fe()},get children(){return t("br.restore")}})]}}),o(be,{w:"$full",display:"flex",flexDirection:"column",get children(){return o(ye,{w:"$full",direction:"column",gap:"$1",get children(){return[o(A,{get children(){return t("br.override")}}),o(we,{id:"restore-override",get checked(){return p()},onChange:e=>v(e.currentTarget.checked)}),o(A,{get children(){return t("br.encrypt_password")}}),o(Se,{id:"password",type:"password",get placeholder(){return t("br.encrypt_password_placeholder")},onInput:e=>S(e.currentTarget.value)})]}})}}),o(H,{p:"$2",ref(e){var r=y;typeof r=="function"?r(e):y=e},w:"$full",alignItems:"start",rounded:"$md",h:"70vh",bg:"$neutral3",overflowY:"auto",spacing:"$1",get children(){return o(_e,{get each(){return P()},children:e=>o($e,e)})}})]}})};function ve(p,v){const h=new Blob([JSON.stringify(v,null,2)],{type:"application/json"}),S=URL.createObjectURL(h),t=document.createElement("a");t.href=S,t.download=p,t.click(),URL.revokeObjectURL(S)}export{De as default};
