import{cJ as A,C as W,q as H,k as j,l as I,E as y,ag as z,c4 as Z,af as q,U as N,ae as O,H as J,K,L as V,S as Y,o as G,z as Q,A as L,B as X,_ as ee}from"./index-BPdgTgYl.js";class P{constructor(){this.crc=-1}append(n){for(var a=this.crc|0,m=this.table,g=0,w=n.length|0;g<w;g++)a=a>>>8^m[(a^n[g])&255];this.crc=a}get(){return~this.crc}}P.prototype.table=(()=>{var c,n,a,m=[];for(c=0;c<256;c++){for(a=c,n=0;n<8;n++)a=a&1?a>>>1^3988292384:a>>>1;m[c]=a}return m})();const T=c=>{var n=new Uint8Array(c);return{array:n,view:new DataView(n.buffer)}},te=c=>c.reader.read().then(n=>{if(n.done)return c.writeFooter();const a=n.value;c.crc.append(a),c.uncompressedLength+=a.length,c.compressedLength+=a.length,c.ctrl.enqueue(a)});function re(c){const n=Object.create(null),a=[],m=new TextEncoder;let g=0,w=0,f,d,p;function h(){w++,d=n[a[w]],d?x():p&&U()}var b={enqueue(l){if(p)throw new TypeError("Cannot enqueue a chunk into a readable stream that is closed or has been requested to be closed");let r=l.name.trim();const t=new Date(typeof l.lastModified>"u"?Date.now():l.lastModified);if(l.directory&&!r.endsWith("/")&&(r+="/"),n[r])throw new Error("File already exists.");const o=m.encode(r);a.push(r);const e=n[r]={level:0,ctrl:f,directory:!!l.directory,nameBuf:o,comment:m.encode(l.comment||""),compressedLength:0,uncompressedLength:0,writeHeader(){var i=T(26),s=T(30+o.length);e.offset=g,e.header=i,e.level!==0&&!e.directory&&i.view.setUint16(4,2048),i.view.setUint32(0,335546376),i.view.setUint16(6,(t.getHours()<<6|t.getMinutes())<<5|t.getSeconds()/2,!0),i.view.setUint16(8,(t.getFullYear()-1980<<4|t.getMonth()+1)<<5|t.getDate(),!0),i.view.setUint16(22,o.length,!0),s.view.setUint32(0,1347093252),s.array.set(i.array,4),s.array.set(o,30),g+=s.array.length,f.enqueue(s.array)},writeFooter(){var i=T(16);i.view.setUint32(0,1347094280),e.crc&&(e.header.view.setUint32(10,e.crc.get(),!0),e.header.view.setUint32(14,e.compressedLength,!0),e.header.view.setUint32(18,e.uncompressedLength,!0),i.view.setUint32(4,e.crc.get(),!0),i.view.setUint32(8,e.compressedLength,!0),i.view.setUint32(12,e.uncompressedLength,!0)),f.enqueue(i.array),g+=e.compressedLength+16,h()},fileLike:l};d||(d=e,x())},close(){if(p)throw new TypeError("Cannot close a readable stream that has already been requested to be closed");d||U(),p=!0}};function U(){var l=0,r=0,t,o;for(t=0;t<a.length;t++)o=n[a[t]],l+=46+o.nameBuf.length+o.comment.length;const e=T(l+22);for(t=0;t<a.length;t++)o=n[a[t]],e.view.setUint32(r,1347092738),e.view.setUint16(r+4,5120),e.array.set(o.header.array,r+6),e.view.setUint16(r+32,o.comment.length,!0),o.directory&&e.view.setUint8(r+38,16),e.view.setUint32(r+42,o.offset,!0),e.array.set(o.nameBuf,r+46),e.array.set(o.comment,r+46+o.nameBuf.length),r+=46+o.nameBuf.length+o.comment.length;e.view.setUint32(r,1347093766),e.view.setUint16(r+8,a.length,!0),e.view.setUint16(r+10,a.length,!0),e.view.setUint32(r+12,l,!0),e.view.setUint32(r+16,g,!0),f.enqueue(e.array),f.close()}function x(){if(d){if(d.directory)return d.writeFooter(d.writeHeader());if(d.reader)return te(d);d.fileLike.stream?(d.crc=new P,d.reader=d.fileLike.stream.getReader(),d.writeHeader()):h()}}return new ReadableStream({start:l=>{f=l,c.start&&Promise.resolve(c.start(b))},pull(){return x()||c.pull&&Promise.resolve(c.pull(b))}})}window.ZIP=re;var _={exports:{}};/*! streamsaver. MIT License. Jimmy WÃ¤rting <https://jimmy.warting.se/opensource> */var B;function ae(){return B||(B=1,(function(c){((n,a)=>{c.exports=a()})("streamSaver",()=>{const n=typeof window=="object"?window:this;n.HTMLElement||console.warn("streamsaver is meant to run on browsers main thread");let a=null,m=!1;const g=r=>{try{r()}catch(t){}},w=n.WebStreamsPolyfill||{},f=n.isSecureContext;let d=/constructor/i.test(n.HTMLElement)||!!n.safari||!!n.WebKitPoint;const p=f||"MozAppearance"in document.documentElement.style?"iframe":"navigate",h={createWriteStream:l,WritableStream:n.WritableStream||w.WritableStream,supported:!0,version:{full:"2.0.5",major:2,minor:0,dot:5},mitm:"https://jimmywarting.github.io/StreamSaver.js/mitm.html?version=2.0.0"};function b(r){if(!r)throw new Error("meh");const t=document.createElement("iframe");return t.hidden=!0,t.src=r,t.loaded=!1,t.name="iframe",t.isIframe=!0,t.postMessage=(...o)=>t.contentWindow.postMessage(...o),t.addEventListener("load",()=>{t.loaded=!0},{once:!0}),document.body.appendChild(t),t}function U(r){const t="width=200,height=100",o=document.createDocumentFragment(),e={frame:n.open(r,"popup",t),loaded:!1,isIframe:!1,isPopup:!0,remove(){e.frame.close()},addEventListener(...s){o.addEventListener(...s)},dispatchEvent(...s){o.dispatchEvent(...s)},removeEventListener(...s){o.removeEventListener(...s)},postMessage(...s){e.frame.postMessage(...s)}},i=s=>{s.source===e.frame&&(e.loaded=!0,n.removeEventListener("message",i),e.dispatchEvent(new Event("load")))};return n.addEventListener("message",i),e}try{new Response(new ReadableStream),f&&!("serviceWorker"in navigator)&&(d=!0)}catch(r){d=!0}g(()=>{const{readable:r}=new TransformStream,t=new MessageChannel;t.port1.postMessage(r,[r]),t.port1.close(),t.port2.close(),m=!0,Object.defineProperty(h,"TransformStream",{configurable:!1,writable:!1,value:TransformStream})});function x(){a||(a=f?b(h.mitm):U(h.mitm))}function l(r,t,o){let e={size:null,pathname:null,writableStrategy:void 0,readableStrategy:void 0},i=0,s=null,u=null,E=null;if(Number.isFinite(t)?([o,t]=[t,o],console.warn("[StreamSaver] Deprecated pass an object as 2nd argument when creating a write stream"),e.size=o,e.writableStrategy=t):t&&t.highWaterMark?(console.warn("[StreamSaver] Deprecated pass an object as 2nd argument when creating a write stream"),e.size=o,e.writableStrategy=t):e=t||{},!d){x(),u=new MessageChannel,r=encodeURIComponent(r.replace(/\//g,":")).replace(/['()]/g,escape).replace(/\*/g,"%2A");const v={transferringReadable:m,pathname:e.pathname||Math.random().toString().slice(-6)+"/"+r,headers:{"Content-Type":"application/octet-stream; charset=utf-8","Content-Disposition":"attachment; filename*=UTF-8''"+r}};e.size&&(v.headers["Content-Length"]=e.size);const C=[v,"*",[u.port2]];if(m){const S=p==="iframe"?void 0:{transform(F,$){if(!(F instanceof Uint8Array))throw new TypeError("Can only write Uint8Arrays");i+=F.length,$.enqueue(F),s&&(location.href=s,s=null)},flush(){s&&(location.href=s)}};E=new h.TransformStream(S,e.writableStrategy,e.readableStrategy);const k=E.readable;u.port1.postMessage({readableStream:k},[k])}u.port1.onmessage=S=>{S.data.download?p==="navigate"?(a.remove(),a=null,i?location.href=S.data.download:s=S.data.download):(a.isPopup&&(a.remove(),a=null,p==="iframe"&&b(h.mitm)),b(S.data.download)):S.data.abort&&(M=[],u.port1.postMessage("abort"),u.port1.onmessage=null,u.port1.close(),u.port2.close(),u=null)},a.loaded?a.postMessage(...C):a.addEventListener("load",()=>{a.postMessage(...C)},{once:!0})}let M=[];return!d&&E&&E.writable||new h.WritableStream({write(v){if(!(v instanceof Uint8Array))throw new TypeError("Can only write Uint8Arrays");if(d){M.push(v);return}u.port1.postMessage(v),i+=v.length,s&&(location.href=s,s=null)},close(){if(d){const v=new Blob(M,{type:"application/octet-stream; charset=utf-8"}),C=document.createElement("a");C.href=URL.createObjectURL(v),C.download=r,C.click()}else u.port1.postMessage("end")},abort(){M=[],u.port1.postMessage("abort"),u.port1.onmessage=null,u.port1.close(),u.port2.close(),u=null}},e.writableStrategy)}return h})})(_)),_.exports}var ne=ae();const R=A(ne);R.mitm="/streamer/mitm.html";const se=c=>c.replace(/^\/+|\/+$/g,"");let D=0;const ie=c=>{const n=H(),[a,m]=W(n("home.package_download.initializing")),[g,w]=W(0),{pathname:f,isShare:d}=j(),p=I(),h=async(l,r)=>{var t;if(r.is_dir){const o=await X(L(f(),l,r.name),ee());if(o.code!==200)return o.message;const e=[];for(const i of(t=o.data.content)!=null?t:[]){const s=await h(L(l,r.name),i);if(typeof s=="string")return s;e.push(...s)}return e}else return D+=r.size,[{path:L(l,r.name),url:Q(L(f(),l),r,"direct",d(),!0)}]},[b,U]=W([]);return(async()=>{let l=G(f());p.length===1&&(l=p[0].name),l||(l=n("manage.sidemenu.home"));let r=R.createWriteStream("".concat(l,".zip"),{size:D});m(n("home.package_download.fetching_struct")),w(2);const t=[];for(const i of p){const s=await h("",i);if(typeof s=="string")return m("".concat(n("home.package_download.fetching_struct_failed"),": ").concat(s)),w(1),s;t.push(...s)}m(n("home.package_download.downloading")),w(3);let o=t.values(),e=new window.ZIP({pull(i){const s=o.next();if(s.done)i.close();else{let u=se(s.value.path);p.length===1&&(u=u.replace("".concat(l,"/"),""));const E=s.value.url;return fetch(E).then(M=>{U(v=>[...v,u]),i.enqueue({name:u,stream:M.body})})}}});if(window.WritableStream&&e.pipeTo)return e.pipeTo(r).then(()=>{m("".concat(n("home.package_download.success"))),w(4)}).catch(i=>{m("".concat(n("home.package_download.failed"),": ").concat(i)),w(1)})})(),[y(J,{get children(){return y(z,{w:"$full",alignItems:"start",spacing:"$2",get children(){return[y(Z,{get children(){return[q(()=>n("home.package_download.current_status")),": ",q(()=>a())]}}),y(N,{get each(){return b()},children:l=>y(O,{css:{wordBreak:"break-all"},get children(){return["Fetching: ",l]}})})]}})}}),y(Y,{get when(){return[1,4].includes(g())},get children(){return y(K,{get children(){return y(V,{colorScheme:"info",get onClick(){return c.onClose},get children(){return n("global.close")}})}})}})]};export{ie as default};
