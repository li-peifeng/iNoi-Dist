import{aL as p,bd as A,bv as z,C as f,E as t,aH as N,bg as Y,c4 as re,S as w,aO as J,cC as Ge,cD as He,ae as R,c3 as xe,d0 as ye,L as S,q as P,by as F,x as Z,af as ee,ag as U,d1 as Ve,d2 as b,U as Se,d3 as We,b3 as pe,P as D,O as je,D as Xe,I as qe,R as L,bX as Ke,aN as ne,b0 as I,d4 as ae,d5 as se,d6 as le,d7 as Je}from"./index-DzgZRDPa.js";import{P as Qe}from"./Paginator-BBOjPZUc.js";const Ye={7:"danger",2:"success",4:"neutral"},Ze=e=>{if(e.role<0)return null;const n=["info","neutral","accent"];return t(pe,{get colorScheme(){return n[e.role]},css:{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"},get children(){return e.name}})},et=e=>{const n=P();return t(pe,{get colorScheme(){var c;return(c=Ye[e.state])!=null?c:"info"},get children(){return n("tasks.state.".concat(e.state))}})},l=[{name:"name",textAlign:"left",w:p().role===2?"calc(100% - 660px)":"calc(100% - 560px)"},{name:"creator",textAlign:"center",w:p().role===2?"100px":"0"},{name:"state",textAlign:"center",w:"100px"},{name:"progress",textAlign:"left",w:"140px"},{name:"speed",textAlign:"center",w:"100px"},{name:"operation",textAlign:"right",w:"220px"}],Q=e=>Math.floor(e).toString().padStart(2,"0"),tt=e=>{const n=e/1e3%60,c=e/1e3/60%60,s=e/1e3/3600;return"".concat(Q(s),":").concat(Q(c),":").concat(Q(n))},rt=e=>{const n=P(),c=e.done==="undone"?"cancel":"delete",s=e.done==="done"&&(e.state===7||e.state===4),[o,i]=A(()=>z.post("/task/".concat(e.type,"/").concat(c,"?tid=").concat(e.id))),[v,m]=A(()=>z.post("/task/".concat(e.type,"/retry?tid=").concat(e.id))),[g,$]=f(!1),_=e.name.match(e.nameAnalyzer.regex),O=_===null?e.name:e.nameAnalyzer.title(_),h=e.start_time===null?-1:new Date(e.start_time).getTime(),G=e.end_time===null?new Date().getTime():new Date(e.end_time).getTime();let E="-";const H=(d,x)=>{let k=x/d,T="bytes/s";return k>1e3&&(k/=1e3,T="KB/s"),k>1e3&&(k/=1e3,T="MB/s"),k>1e3&&(k/=1e3,T="GB/s"),k>1e3&&(k/=1e3,T="TB/s"),"".concat(k.toFixed(2)," ").concat(T)};if(e.done){if(e.start_time!==e.end_time&&e.progress>0&&h!==-1){const d=(G-h)/1e3,x=e.total_bytes*e.progress/100;E=H(d,x)}}else if(e.prevProgress!==void 0&&e.prevFetchTime!==void 0){const d=(e.curFetchTime-e.prevFetchTime)/1e3,x=(e.progress-e.prevProgress)*e.total_bytes/100;E=H(d,x)}return t(w,{get when(){return!g()},get children(){return[t(N,{w:"$full",p:"$2",get children(){return[t(N,{get w(){return l[0].w},spacing:"$1",get children(){return[t(Y,{"on:click":d=>{d.stopPropagation()},get checked(){return e.local.selected},onChange:d=>{e.setLocal({selected:d.target.checked,expanded:e.local.expanded})}}),t(re,{size:"sm",css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:O})]}}),t(w,{get when(){return p().role===2},get children(){return t(J,{get w(){return l[1].w},get children(){return t(Ze,{get name(){return e.creator},get role(){return e.creator_role}})}})}}),t(J,{get w(){return l[2].w},get children(){return t(et,{get state(){return e.state}})}}),t(Ge,{get w(){return l[3].w},trackColor:"$info3",rounded:"$full",size:"sm",get value(){return e.progress},mr:"$1",get children(){return t(He,{color:"$info8",rounded:"$md"})}}),t(J,{get w(){return l[1].w},get children(){return t(R,{size:"sm",css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:E})}}),t(xe,{get w(){return l[5].w},gap:"$1",get children(){return[t(ye,{}),t(w,{get when(){return e.canRetry},get children(){return t(S,{size:"sm",disabled:!s,display:s?"block":"none",get loading(){return v()},onClick:async()=>{const d=await m();F(d,()=>{Z.info(n("tasks.retry")),$(!0)})},get children(){return n("tasks.retry")}})}}),t(S,{size:"sm",colorScheme:"danger",get loading(){return o()},onClick:async()=>{const d=await i();F(d,()=>{Z.success(n("global.delete_success")),$(!0)})},get children(){return n("global.".concat(c))}}),t(S,{size:"sm",colorScheme:"neutral",onClick:()=>{e.setLocal({selected:e.local.selected,expanded:!e.local.expanded})},get children(){return ee(()=>!!e.local.expanded)()?n("tasks.fold"):n("tasks.expand")}})]}})]}}),t(w,{get when(){return e.local.expanded},get children(){return t(U,{css:{wordBreak:"break-all",fontSize:"0.8em"},w:"$full",pl:"$2",pr:"$2",get children(){return[t(Ve,{templateColumns:"min-content 1fr",w:"$full",columnGap:"$4",mb:"$2",get children(){return[t(w,{when:h!==-1,get children(){return[t(b,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return n("tasks.attr.time_elapsed")}}),t(b,{color:"$neutral9",get children(){return tt(G-h)}})]}}),t(w,{when:_!==null,get children(){return t(Se,{get each(){return Object.entries(e.nameAnalyzer.attrs)},children:d=>{const x=d[1](_);return x===void 0?null:t(w,{get when(){return d[1]!==void 0},get children(){return[t(b,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return d[0]}}),t(b,{color:"$neutral9",children:x})]}})}})}}),t(b,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return n("tasks.attr.status")}}),t(b,{color:"$neutral9",get children(){return e.status}}),t(w,{get when(){return e.error},get children(){return[t(b,{color:"$danger9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return n("tasks.attr.err")}}),t(b,{color:"$danger9",get children(){return e.error}})]}})]}}),t(We,{})]}})}})]}})},nt=e=>{const n=P(),[c,s]=A(()=>z.get("/task/".concat(e.type,"/").concat(e.done))),[o,i]=f([]),[v,m]=f("name"),[g,$]=f(!1),_={name:(r,a)=>r.name>a.name?1:-1,creator:(r,a)=>r.creator===a.creator?r.id>a.id?1:-1:r.creator>a.creator?1:-1,state:(r,a)=>r.state===a.state?r.id>a.id?1:-1:r.state>a.state?1:-1,progress:(r,a)=>r.progress===a.progress?r.id>a.id?1:-1:r.progress<a.progress?1:-1},O=D(()=>(r,a)=>(g()?-1:1)*_[v()](r,a)),h=async()=>{const r=await s();F(r,a=>{var ke;const y=new Date().getTime(),me={},fe={},X={},we={},$e={};for(const u of o())me[u.id]=u.curFetchTime,fe[u.id]=u.prevFetchTime,X[u.id]=u.progress,we[u.id]=u.prevProgress,$e[u.id]=u.local;i((ke=a==null?void 0:a.map(u=>{var ve;let q,K;u.progress===X[u.id]?(q=fe[u.id],K=we[u.id]):(q=me[u.id],K=X[u.id]);const Ue=(ve=$e[u.id])!=null?ve:{selected:!1,expanded:!1};return{...u,curFetchTime:y,prevFetchTime:q,prevProgress:K,local:Ue}}).sort(O()))!=null?ke:[])})};if(h(),e.done==="undone"){const r=setInterval(h,2e3);je(()=>clearInterval(r))}const[G,E]=A(()=>z.post("/task/".concat(e.type,"/clear_done"))),[H,d]=A(()=>z.post("/task/".concat(e.type,"/clear_succeeded"))),[x,k]=A(()=>z.post("/task/".concat(e.type,"/retry_failed"))),[T,Te]=f(""),[Ce,be]=f(new RegExp("")),[Ae,ce]=f(!1);Xe(()=>{try{be(new RegExp(T())),ce(!1)}catch(r){ce(!0)}});const[oe,ze]=f(p().role!==2),W=D(()=>{const r=Ce(),a=oe();return y=>r.test(y.name)&&(!a||y.creator===p().username)}),C=D(()=>o().filter(W())),ie=D(()=>C().map(r=>r.local.selected).every(Boolean)),Fe=D(()=>C().map(r=>r.local.selected).some(Boolean)&&!ie()),Pe=r=>i(o().map(a=>(W()(a)&&(a.local.selected=r),a))),de=D(()=>C().map(r=>r.local.expanded).every(Boolean)),De=r=>i(o().map(a=>(W()(a)&&(a.local.expanded=r),a))),ue=()=>C().filter(r=>r.local.selected).map(r=>r.id),[Le,Re]=A(()=>z.post("/task/".concat(e.type,"/retry_some"),ue())),[Oe,Be]=A(()=>z.post("/task/".concat(e.type,"/").concat(he,"_some"),ue())),ge=r=>{Object.entries(r).forEach(([a,y])=>{Z.error("".concat(a,": ").concat(y))})},[Ie,Me]=f(1),j=20,he=e.done==="undone"?"cancel":"delete",Ee=D(()=>{const r=(Ie()-1)*j,a=r+j;return C().slice(r,a)}),B=r=>({fontWeight:"bold",fontSize:"$sm",color:"$neutral11",textAlign:r.textAlign}),V=r=>({cursor:"pointer",onClick:()=>{v()===r.name?$(!g()):Ke(()=>{m(r.name),$(!1)}),h()}}),Ne=r=>a=>i(o().map(y=>(y.id===r&&(y.local=a),y)));return t(U,{w:"$full",alignItems:"start",spacing:"$2",get children(){return[t(re,{size:"lg",get children(){return n("tasks.".concat(e.done))}}),t(N,{gap:"$2",flexWrap:"wrap",get children(){return[t(w,{get when(){return e.done==="done"},get children(){return[t(S,{colorScheme:"accent",get loading(){return c()},onClick:h,get children(){return n("global.refresh")}}),t(S,{get loading(){return x()},onClick:async()=>{const r=await k();F(r,()=>h())},get children(){return n("tasks.retry_failed")}}),t(S,{colorScheme:"danger",get loading(){return G()},onClick:async()=>{const r=await E();F(r,()=>h())},get children(){return n("global.clear")}}),t(S,{colorScheme:"success",get loading(){return H()},onClick:async()=>{const r=await d();F(r,()=>h())},get children(){return n("tasks.clear_succeeded")}})]}}),t(w,{get when(){return e.canRetry},get children(){return t(S,{colorScheme:"primary",get loading(){return Le()},onClick:async()=>{const r=await Re();F(r,a=>{ge(a),h()})},get children(){return n("tasks.retry_selected")}})}}),t(S,{colorScheme:"warning",get loading(){return Oe()},onClick:async()=>{const r=await Be();F(r,a=>{ge(a),h()})},get children(){return n("tasks.".concat(he,"_selected"))}}),t(qe,{width:"auto",get placeholder(){return n("tasks.filter")},get value(){return T()},onInput:r=>Te(r.target.value),get invalid(){return Ae()}}),t(w,{get when(){return p().role===2},get children(){return t(Y,{get checked(){return oe()},onChange:r=>ze(r.target.checked),get children(){return n("tasks.show_only_mine")}})}})]}}),t(U,{w:{"@initial":"1024px","@lg":"$full"},overflowX:"auto",shadow:"$md",rounded:"$lg",spacing:"$1",p:"$1",get children(){return[t(N,{class:"title",w:"$full",p:"$2",get children(){return[t(N,{get w(){return l[0].w},spacing:"$1",get children(){return[t(Y,{get disabled(){return C().length===0},get checked(){return ie()},get indeterminate(){return Fe()},onChange:r=>Pe(r.target.checked)}),t(R,L(()=>B(l[0]),()=>V(l[0]),{get children(){return n("tasks.attr.".concat(l[0].name))}}))]}}),t(w,{get when(){return p().role===2},get children(){return t(R,L({get w(){return l[1].w}},()=>B(l[1]),()=>V(l[1]),{get children(){return n("tasks.attr.".concat(l[1].name))}}))}}),t(R,L({get w(){return l[2].w}},()=>B(l[2]),()=>V(l[2]),{get children(){return n("tasks.attr.".concat(l[2].name))}})),t(R,L({get w(){return l[3].w}},()=>B(l[3]),()=>V(l[3]),{get children(){return n("tasks.attr.".concat(l[3].name))}})),t(R,L({get w(){return l[4].w}},()=>B(l[4]),{get children(){return n("tasks.attr.".concat(l[4].name))}})),t(xe,{get w(){return l[5].w},gap:"$2",get children(){return[t(ye,{}),t(R,L(()=>B(l[5]),{get children(){return n("tasks.attr.".concat(l[5].name))}})),t(S,{size:"xs",colorScheme:"neutral",onClick:()=>De(!de()),get disabled(){return C().length===0},get children(){return ee(()=>!!de())()?n("tasks.fold_all"):n("tasks.expand_all")}})]}})]}}),ee(()=>Ee().map(r=>t(rt,L(r,e,{get setLocal(){return Ne(r.id)}}))))]}}),t(Qe,{get total(){return C().length},defaultPageSize:j,onChange:r=>{Me(r)}})]}})},ct=e=>{const n=P();return t(U,{w:"$full",alignItems:"start",spacing:"$4",get children(){return[t(re,{size:"xl",get children(){return n("tasks.".concat(e.type))}}),t(U,{w:"$full",spacing:"$2",get children(){return t(Se,{each:["undone","done"],children:c=>t(nt,{get type(){return e.type},done:c,get canRetry(){return e.canRetry},get nameAnalyzer(){return e.nameAnalyzer}})})}})]}})};var at=ne("<a>"),te=ne("<p>"),_e=ne("<a target=_blank>");const M=(e,n,c=!0)=>{const s=(e==="/"?"":e)+n,o=p().base_path==="/"?"":p().base_path,i=s.startsWith(o),[v,m]=f(!1);return i&&c?(()=>{var g=at();return g.$$mouseout=()=>m(!1),g.$$mouseover=()=>m(!0),I(g,s),ae($=>{var _=v()?"text-decoration: underline":"",O=s.slice(o.length);return $.e=se(g,_,$.e),O!==$.t&&le(g,"href",$.t=O),$},{e:void 0,t:void 0}),g})():(()=>{var g=te();return I(g,s),g})()},ot=()=>{const e=P(),[n,c]=f(!1);return{regex:/^download (.+) to \((.+)\)$/,title:s=>s[1],attrs:{[e("tasks.attr.offline_download.url")]:s=>(()=>{var o=_e();return o.$$mouseout=()=>c(!1),o.$$mouseover=()=>c(!0),I(o,()=>s[1]),ae(i=>{var v=n()?"text-decoration: underline":"",m=s[1];return i.e=se(o,v,i.e),m!==i.t&&le(o,"href",i.t=m),i},{e:void 0,t:void 0}),o})(),[e("tasks.attr.offline_download.path")]:s=>M("",s[2])}}},it=()=>{const e=P(),[n,c]=f(!1);return{regex:/^(transfer|upload) \[(.*)]\((.*\/([^\/]+))\) to \[(.+)]\((.+)\)$/,title:s=>s[1]==="upload"?s[2]:s[4],attrs:{[e("tasks.attr.offline_download.transfer_src")]:s=>s[1]!=="transfer"||s[2]===""?void 0:M(s[2],s[3]),[e("tasks.attr.offline_download.transfer_src_local")]:s=>s[2]===""?s[3]:void 0,[e("tasks.attr.offline_download.url")]:s=>s[1]==="upload"?(()=>{var o=_e();return o.$$mouseout=()=>c(!1),o.$$mouseover=()=>c(!0),I(o,()=>s[3]),ae(i=>{var v=n()?"text-decoration: underline":"",m=s[3];return i.e=se(o,v,i.e),m!==i.t&&le(o,"href",i.t=m),i},{e:void 0,t:void 0}),o})():void 0,[e("tasks.attr.offline_download.transfer_dst")]:s=>M(s[5],s[6])}}},dt=()=>{const e=P();return{regex:/^decompress \[(.+)]\((.*\/([^\/]+))\)\[(.+)] to \[(.+)]\((.+)\) with password <(.*)>$/,title:n=>n[3],attrs:{[e("tasks.attr.decompress.src")]:n=>M(n[1],n[2]),[e("tasks.attr.decompress.dst")]:n=>M(n[5],n[6]),[e("tasks.attr.decompress.inner")]:n=>(()=>{var c=te();return I(c,()=>n[4]),c})(),[e("tasks.attr.decompress.password")]:n=>(()=>{var c=te();return I(c,()=>n[7]),c})()}}},ut=()=>{const e=P();return{regex:/^upload (.+) to \[(.+)]\((.+)\)$/,title:n=>n[1],attrs:{[e("tasks.attr.decompress.dst")]:n=>M(n[2],n[3])}}};Je(["mouseover","mouseout"]);export{ct as T,it as a,M as b,dt as c,ut as d,ot as g};
