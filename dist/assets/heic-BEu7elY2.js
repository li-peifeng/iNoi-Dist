import{k as x,C as b,a9 as d,at as I,O as k,aN as D,bu as s,b0 as y,E as f,aa as P,S as v,a8 as B,q as H,dp as L,ee as A}from"./index-Bo0ZXHp1.js";var F=D("<div id=heic-container style=justify-content:center;align-items:center><canvas style=max-width:100%;max-height:100%;object-fit:contain>");const R=()=>{const _=H();x();const[u,o]=b(!0),[w,c]=b(!1);let g=d.objs.filter(e=>/\.(heic|heif|avif|vvc|avc|jpeg|jpg)$/i.test(e.name));g.length===0&&(g=[d.obj]);let l,h,n;I(()=>{j()}),k(()=>{l&&h&&(h=null),l=null});const j=async()=>{o(!0),c(!1);try{window.libheif||await C("/static/libheif/libheif.js","libheif-script");const e=await $("/static/libheif/libheif.wasm");l=window.libheif({wasmBinary:e}),h=new l.HeifDecoder,await E(d.raw_url)}catch(e){console.error("HEIC初始化失败:",e),c(!0),o(!1)}},C=(e,t)=>new Promise((a,i)=>{const r=document.createElement("script");r.src=e,r.id=t,r.onload=()=>a(),r.onerror=()=>i("脚本加载失败: ".concat(e)),document.head.appendChild(r)}),$=async e=>{const t=await fetch(e);if(!t.ok)throw"WASM加载失败: ".concat(e);return await t.arrayBuffer()},E=async e=>{try{o(!0),c(!1);const t=await fetch(e);if(!t.ok)throw"文件获取失败";const a=await t.arrayBuffer(),i=h.decode(a);if(!i||i.length===0)throw"没有可解码的图像";const r=i[0];await S(r),o(!1)}catch(t){console.error("HEIC解码失败:",t),c(!0),o(!1)}},S=e=>new Promise(t=>{if(!n)return t();const a=e.get_width(),i=e.get_height();n.width=a,n.height=i;const r=new ImageData(a,i);e.display(r,p=>{if(!p||!n)return t();const m=n.getContext("2d");if(!m)return t();m.putImageData(p,0,0),t()})});return(()=>{var e=F(),t=e.firstChild;s(e,"position","relative"),s(e,"width","100%"),s(e,"height","75vh"),s(e,"display","flex"),s(e,"overflow","hidden");var a=n;return typeof a=="function"?A(a,t):n=t,y(e,f(v,{get when(){return u()},get children(){return f(P,{})}}),null),y(e,f(v,{get when(){return w()},get children(){return f(B,{get msg(){return _("preview.failed_load_heic")},h:"75vh"})}}),null),L(i=>s(t,"display",u()||w()?"none":"block")),e})()};export{R as default};
