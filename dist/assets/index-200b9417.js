import{cd as le,af as I,W as k,d as W,c8 as b,ce as S,x as q,y as e,aQ as J,bm as w,cf as ce,cg as ue,ch as ge,Z as N,b as de,G as pe,q as p,ci as he,b5 as A,am as me,aa as fe,bT as T,aD as we,bS as be,S as m,I as U,b7 as B,a9 as Se,Q as $e,aA as Ce,D as M,bx as _e,aG as ke,n as f,bn as Ie,cj as H}from"./index-2af1ede7.js";import{F as ye,f as ve,a as xe,S as Le,g as Ee}from"./index-0da3eaa7.js";import{s as Pe,g as Re,a as Ae}from"./webauthn-json.browser-ponyfill-29d8152c.js";const Te="https://github.com/li-peifeng/inoi";function Ue(c){return le("".concat(c,"-").concat(Te))}const Me=()=>{const c=I("sso_login_enabled"),y=k("sso_login_platform"),n=I("sso_compatibility_mode"),{searchParams:u,to:$}=W(),s=u.token;s!=null&&s!=""&&(b(s),$(decodeURIComponent(u.redirect||S||"/"),!0));function h(i){const o=i.data;o.token&&(b(o.token),$(decodeURIComponent(u.redirect||S||"/"),!0))}if(window.addEventListener("message",h),q(()=>{window.removeEventListener("message",h)}),c){const i=()=>{const g=w.getUri()+"/auth/sso?method=sso_get_token";if(n){window.location.href=g;return}window.open(g,"authPopup","width=500,height=600")};let o;switch(y){case"Github":o=ve;break;case"Microsoft":o=ge;break;case"Google":o=ue;break;case"Dingtalk":o=ce;break;default:o=ye}return e(J,{cursor:"pointer",boxSize:"$8",as:o,p:"$0_5",onclick:i})}},De=()=>{const c=k("logo").split("\n"),y=N(c[0],c.pop()),n=de(),u=pe(()=>"".concat(k("site_title")));xe(u);const $=N("white","$neutral1"),[s,h]=p(localStorage.getItem("username")||""),[i,o]=p(localStorage.getItem("password")||""),[g,O]=p(""),[C,Q]=p(!1),[_,V]=he("remember-pwd","false"),[v,F]=p(!1),[Z,X]=A(async()=>v()?w.post("/auth/login/ldap",{username:s(),password:i(),otp_code:g()}):w.post("/auth/login/hash",{username:s(),password:Ue(i()),otp_code:g()})),[,Y]=A((t,r,d,R)=>w.post("/authn/webauthn_finish_login?username="+d,JSON.stringify(r),{headers:{session:t},signal:R})),[,ee]=A((t,r)=>w.get("/authn/webauthn_begin_login?username="+t,{signal:r})),{searchParams:x,to:L}=W(),te=async()=>PublicKeyCredential&&"isConditionalMediationAvailable"in PublicKeyCredential?await PublicKeyCredential.isConditionalMediationAvailable():!1,z=I("webauthn_login_enabled"),ne=async()=>{Q(!C())};let a=null;const D=async t=>{if(!Pe()){t||f.error(n("users.webauthn_not_supported"));return}if(t&&!await te())return;a==null||a.abort();const r=new AbortController;a=r;const d=t?"":s();!t&&_()==="true"?localStorage.setItem("username",s()):localStorage.removeItem("username");const R=await ee(d,r.signal);Ie(R,async j=>{try{const l=Re(j.options);l.signal=r.signal,t&&(l.mediation="conditional");const se=await Ae(l),ae=await Y(j.session,se,d,r.signal);H(ae,ie=>{f.success(n("login.success")),b(ie.token),L(decodeURIComponent(x.redirect||S||"/"),!0)})}catch(l){l instanceof Error&&l.name!="AbortError"&&f.error(l.message)}})},G=()=>a==null?void 0:a.abort();me(()=>{z&&(window.addEventListener("beforeunload",G),D(!0))}),q(()=>{a==null||a.abort(),window.removeEventListener("beforeunload",G)});const E=async()=>{if(C())await D();else{_()==="true"?(localStorage.setItem("username",s()),localStorage.setItem("password",i())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const t=await X();H(t,r=>{f.success(n("login.success")),b(r.token),L(decodeURIComponent(x.redirect||S||"/"),!0)},(r,d)=>{!P()&&d===402?oe(!0):f.error(r)})}},[P,oe]=p(!1),K=I("ldap_login_enabled"),re=k("ldap_login_tips");return K&&F(!0),e(ke,{zIndex:"1",w:"$full",h:"100vh",get children(){return e(fe,{get bgColor(){return $()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[e(T,{alignItems:"center",justifyContent:"space-around",get children(){return[e(we,{mr:"$2",boxSize:"$12",get src(){return y()}}),e(be,{color:"$info9",fontSize:"$2xl",get children(){return u()}})]}}),e(m,{get when(){return!P()},get fallback(){return e(U,{id:"totp",name:"otp",get placeholder(){return n("login.otp-tips")},get value(){return g()},onInput:t=>O(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&E()}})},get children(){return[e(U,{name:"username",get placeholder(){return n("login.username-tips")},get value(){return s()},onInput:t=>h(t.currentTarget.value)}),e(m,{get when(){return!C()},get children(){return e(U,{name:"password",get placeholder(){return n("login.password-tips")},type:"password",get value(){return i()},onInput:t=>o(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&E()}})}}),e(T,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return[e(B,{get checked(){return _()==="true"},onChange:()=>V(_()==="true"?"false":"true"),get children(){return n("login.remember")}}),e(Se,{color:"$success9",as:$e,href:"https://peifeng.li/cloud-help",get children(){return n("login.help")}})]}})]}}),e(Ce,{w:"$full",spacing:"$2",get children(){return[e(m,{get when(){return!C()},get children(){return[e(M,{w:"$full",colorScheme:"danger",onClick:()=>{b(),L(decodeURIComponent(x.redirect||S||"/"),!0)},get children(){return n("login.use_guest")}}),e(M,{colorScheme:"warning",w:"$full",onClick:()=>{P()?O(""):(h(""),o(""))},get children(){return n("login.clear")}})]}}),e(M,{colorScheme:"success",w:"$full",get loading(){return Z()},onClick:E,get children(){return n("login.login")}})]}}),e(m,{when:K,get children(){return e(B,{w:"$full",get checked(){return v()===!0},onChange:()=>F(!v()),children:re})}}),e(T,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[e(Le,{}),e(Me,{}),e(m,{when:z,get children(){return e(J,{cursor:"pointer",boxSize:"$8",as:Ee,p:"$0_5",onclick:ne})}}),e(_e,{})]}})]}})}})};export{De as default};
