import{ck as le,k as H,cf as b,cl as C,O as W,E as e,aW as J,aq as I,bt as w,cm as ce,cn as ue,co as ge,a3 as k,a8 as N,P as de,C as p,cp as pe,bc as R,au as he,ah as me,bZ as U,aI as fe,b_ as we,S as m,I as A,q as be,bf as j,a4 as Ce,a0 as Se,a7 as _e,L as M,bE as $e,aO as ke,cq as B,x as f,bw as Ie}from"./index-ELNf8afL.js";import{F as ye,g as ve,a as Le,S as xe,h as Ee}from"./index-CMnaFHON.js";import{s as Pe,g as Oe,a as Re}from"./webauthn-json.browser-ponyfill-CVZeZdny.js";const Ue="https://github.com/li-peifeng/inoi";function Ae(c){return le("".concat(c,"-").concat(Ue))}const Me=()=>{const c=I("sso_login_enabled"),y=k("sso_login_platform"),n=I("sso_compatibility_mode"),{searchParams:u,to:S}=H(),s=u.token;s!=null&&s!=""&&(b(s),S(decodeURIComponent(u.redirect||C||"/"),!0));function h(i){const o=i.data;o.token&&(b(o.token),S(decodeURIComponent(u.redirect||C||"/"),!0))}if(window.addEventListener("message",h),W(()=>{window.removeEventListener("message",h)}),c){const i=()=>{const g=w.getUri()+"/auth/sso?method=sso_get_token";if(n){window.location.href=g;return}window.open(g,"authPopup","width=500,height=600")};let o;switch(y){case"Github":o=ve;break;case"Microsoft":o=ge;break;case"Google":o=ue;break;case"Dingtalk":o=ce;break;default:o=ye}return e(J,{cursor:"pointer",boxSize:"$8",as:o,p:"$0_5",onclick:i})}},Ke=()=>{const c=k("logo").split("\n"),y=N(c[0],c.pop()),n=be(),u=de(()=>"".concat(k("site_title")));Le(u);const S=N("white","$neutral1"),[s,h]=p(localStorage.getItem("username")||""),[i,o]=p(localStorage.getItem("password")||""),[g,T]=p(""),[_,V]=p(!1),[$,Z]=pe("remember-pwd","false"),[v,F]=p(!1),[Q,X]=R(async()=>v()?w.post("/auth/login/ldap",{username:s(),password:i(),otp_code:g()}):w.post("/auth/login/hash",{username:s(),password:Ae(i()),otp_code:g()})),[,Y]=R((t,r,d,O)=>w.post("/authn/webauthn_finish_login?username="+d,JSON.stringify(r),{headers:{session:t},signal:O})),[,ee]=R((t,r)=>w.get("/authn/webauthn_begin_login?username="+t,{signal:r})),{searchParams:L,to:x}=H(),te=async()=>PublicKeyCredential&&"isConditionalMediationAvailable"in PublicKeyCredential?await PublicKeyCredential.isConditionalMediationAvailable():!1,z=I("webauthn_login_enabled"),ne=async()=>{V(!_())};let a=null;const K=async t=>{if(!Pe()){t||f.error(n("users.webauthn_not_supported"));return}if(t&&!await te())return;a==null||a.abort();const r=new AbortController;a=r;const d=t?"":s();!t&&$()==="true"?localStorage.setItem("username",s()):localStorage.removeItem("username");const O=await ee(d,r.signal);Ie(O,async G=>{try{const l=Oe(G.options);l.signal=r.signal,t&&(l.mediation="conditional");const se=await Re(l),ae=await Y(G.session,se,d,r.signal);B(ae,ie=>{f.success(n("login.success")),b(ie.token),x(decodeURIComponent(L.redirect||C||"/"),!0)})}catch(l){l instanceof Error&&l.name!="AbortError"&&f.error(l.message)}})},q=()=>a==null?void 0:a.abort();he(()=>{z&&(window.addEventListener("beforeunload",q),K(!0))}),W(()=>{a==null||a.abort(),window.removeEventListener("beforeunload",q)});const E=async()=>{if(_())await K();else{$()==="true"?(localStorage.setItem("username",s()),localStorage.setItem("password",i())):(localStorage.removeItem("username"),localStorage.removeItem("password"));const t=await X();B(t,r=>{f.success(n("login.success")),b(r.token),x(decodeURIComponent(L.redirect||C||"/"),!0)},(r,d)=>{!P()&&d===402?oe(!0):f.error(r)})}},[P,oe]=p(!1),D=I("ldap_login_enabled"),re=k("ldap_login_tips");return D&&F(!0),e(ke,{zIndex:"1",w:"$full",h:"100vh",get children(){return e(me,{get bgColor(){return S()},rounded:"$xl",p:"24px",w:{"@initial":"90%","@sm":"364px"},spacing:"$4",get children(){return[e(U,{alignItems:"center",justifyContent:"space-around",get children(){return[e(fe,{mr:"$2",boxSize:"$12",get src(){return y()}}),e(we,{color:"$info9",fontSize:"$2xl",get children(){return u()}})]}}),e(m,{get when(){return!P()},get fallback(){return e(A,{id:"totp",name:"otp",get placeholder(){return n("login.otp-tips")},get value(){return g()},onInput:t=>T(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&E()}})},get children(){return[e(A,{name:"username",get placeholder(){return n("login.username-tips")},get value(){return s()},onInput:t=>h(t.currentTarget.value)}),e(m,{get when(){return!_()},get children(){return e(A,{name:"password",get placeholder(){return n("login.password-tips")},type:"password",get value(){return i()},onInput:t=>o(t.currentTarget.value),onKeyDown:t=>{t.key==="Enter"&&E()}})}}),e(U,{px:"$1",w:"$full",fontSize:"$sm",color:"$neutral10",justifyContent:"space-between",alignItems:"center",get children(){return[e(j,{get checked(){return $()==="true"},onChange:()=>Z($()==="true"?"false":"true"),get children(){return n("login.remember")}}),e(Ce,{color:"$success9",as:Se,href:"https://peifeng.li/cloud-help",get children(){return n("login.help")}})]}})]}}),e(_e,{w:"$full",spacing:"$2",get children(){return[e(m,{get when(){return!_()},get children(){return[e(M,{w:"$full",colorScheme:"danger",onClick:()=>{b(),x(decodeURIComponent(L.redirect||C||"/"),!0)},get children(){return n("login.use_guest")}}),e(M,{colorScheme:"warning",w:"$full",onClick:()=>{P()?T(""):(h(""),o(""))},get children(){return n("login.clear")}})]}}),e(M,{colorScheme:"success",w:"$full",get loading(){return Q()},onClick:E,get children(){return n("login.login")}})]}}),e(m,{when:D,get children(){return e(j,{w:"$full",get checked(){return v()===!0},onChange:()=>F(!v()),children:re})}}),e(U,{mt:"$2",justifyContent:"space-evenly",alignItems:"center",color:"$neutral10",w:"$full",get children(){return[e(xe,{}),e(Me,{}),e(m,{when:z,get children(){return e(J,{cursor:"pointer",boxSize:"$8",as:Ee,p:"$0_5",onclick:ne})}}),e($e,{})]}})]}})}})};export{Ke as default};
