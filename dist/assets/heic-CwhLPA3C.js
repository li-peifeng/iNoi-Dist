import{k as $,C as v,R as d,au as I,O as L,aN as S,a$ as b,E as h,ae as A,S as P,ad as D,q as R,di as B,e8 as H}from"./index-B8BdErJo.js";var F=S("<div id=heic-container><canvas>");const W=()=>{const j=R(),{replace:y}=$(),[w,o]=v(!0),[u,c]=v(!1);let s=d.objs.filter(e=>/\.(heic|heif|avif|vvc|avc|jpeg|jpg)$/i.test(e.name));s.length===0&&(s=[d.obj]);const p=e=>{const t=s.findIndex(r=>r.name===d.obj.name);e.key==="ArrowLeft"&&t>0?y(s[t-1].name):e.key==="ArrowRight"&&t<s.length-1&&y(s[t+1].name)};let f,l,a;I(()=>{window.addEventListener("keydown",p),E()}),L(()=>{window.removeEventListener("keydown",p),f&&l&&(l.free(),l=null),f=null});const E=async()=>{o(!0),c(!1);try{window.libheif||await k("/static/libheif/libheif.js","libheif-script");const e=await x("/static/libheif/libheif.wasm");f=window.libheif({wasmBinary:e}),l=new f.HeifDecoder,await C(d.raw_url)}catch(e){console.error("HEIC初始化失败:",e),c(!0),o(!1)}},k=(e,t)=>new Promise((r,n)=>{const i=document.createElement("script");i.src=e,i.id=t,i.onload=()=>r(),i.onerror=()=>n("脚本加载失败: ".concat(e)),document.head.appendChild(i)}),x=async e=>{const t=await fetch(e);if(!t.ok)throw"WASM加载失败: ".concat(e);return await t.arrayBuffer()},C=async e=>{try{o(!0),c(!1);const t=await fetch(e);if(!t.ok)throw"文件获取失败";const r=await t.arrayBuffer(),n=l.decode(r);if(!n||n.length===0)throw"没有可解码的图像";const i=n[0];await _(i),o(!1)}catch(t){console.error("HEIC解码失败:",t),c(!0),o(!1)}},_=e=>new Promise(t=>{if(!a)return t();const r=e.get_width(),n=e.get_height();a.width=r,a.height=n;const i=new ImageData(r,n);e.display(i,g=>{if(!g||!a)return t();const m=a.getContext("2d");if(!m)return t();m.putImageData(g,0,0),t()})});return(()=>{var e=F(),t=e.firstChild;e.style.setProperty("position","relative"),e.style.setProperty("width","100%"),e.style.setProperty("height","75vh"),e.style.setProperty("display","flex"),e.style.setProperty("justify-content","center"),e.style.setProperty("align-items","center"),e.style.setProperty("overflow","hidden");var r=a;return typeof r=="function"?H(r,t):a=t,t.style.setProperty("max-width","100%"),t.style.setProperty("max-height","100%"),t.style.setProperty("object-fit","contain"),b(e,h(P,{get when(){return w()},get children(){return h(A,{})}}),null),b(e,h(P,{get when(){return u()},get children(){return h(D,{get msg(){return j("preview.failed_load_heic")},h:"75vh"})}}),null),B(n=>(n=w()||u()?"none":"block")!=null?t.style.setProperty("display",n):t.style.removeProperty("display")),e})()};export{W as default};
